<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Factory - NFC</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f0f2f5; padding: 20px; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .table-responsive { max-height: 70vh; overflow-y: auto; }
        .factory-link { font-size: 0.8em; color: #666; font-family: monospace; user-select: all; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h2 class="text-center mb-4">üè≠ Usine & Gestion NFC</h2>

        <div class="card p-4 bg-white border-primary">
            <h5 class="text-primary">1. G√©n√©rer un lot pour l'usine (CSV)</h5>
            <p class="small text-muted">Cela va cr√©er les plaques dans la base de donn√©es et t√©l√©charger le fichier pour l'imprimeur.</p>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Num√©ro de d√©part</label>
                    <input type="number" id="startId" class="form-control" placeholder="ex: 1000">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantit√©</label>
                    <input type="number" id="quantity" class="form-control" value="50">
                </div>
                <div class="col-md-4">
                    <button onclick="generateBatch()" class="btn btn-primary w-100">
                        üöÄ G√©n√©rer & T√©l√©charger CSV
                    </button>
                </div>
            </div>
            <div id="batchStatus" class="mt-2"></div>
        </div>

        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>2. Gestion des redirections (Clients)</h5>
                <button onclick="loadPlaques()" class="btn btn-outline-secondary btn-sm">üîÑ Actualiser le tableau</button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th style="width: 10%">ID Plaque</th>
                            <th style="width: 35%">Lien QR Code (Fixe - Usine)</th>
                            <th style="width: 35%">Lien Redirection (Modifiable)</th>
                            <th style="width: 10%" class="text-center">Vues</th>
                            <th style="width: 10%">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- TA CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBjfZ6GHzg-IkP-i_1RMcWNqvyhSlrUMbk",
            authDomain: "plaques-nfc-c6da0.firebaseapp.com",
            projectId: "plaques-nfc-c6da0",
            storageBucket: "plaques-nfc-c6da0.firebasestorage.app",
            messagingSenderId: "790493007980",
            appId: "1:790493007980:web:de515aa27e78e6a9a58849",
            measurementId: "G-KWT3LZV7S5"
        };
        
        // BASE URL DE TON SITE (Important pour le CSV)
        const BASE_URL = "https://qr.digitagpro.fr/?id=";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Charger au d√©marrage
        loadPlaques();

        // --- FONCTION 1 : GENERER LOT + CSV ---
        async function generateBatch() {
            const start = parseInt(document.getElementById('startId').value);
            const qty = parseInt(document.getElementById('quantity').value);
            const status = document.getElementById('batchStatus');

            if (!start || !qty) {
                alert("Veuillez mettre un num√©ro de d√©part et une quantit√©.");
                return;
            }

            status.innerHTML = `<span class="text-warning">G√©n√©ration de ${qty} plaques en cours...</span>`;

            let csvContent = "data:text/csv;charset=utf-8,ID_PLAQUE,LIEN_A_IMPRIMER\n";
            const batchPromises = [];

            for (let i = 0; i < qty; i++) {
                let currentId = (start + i).toString();
                let fullUrl = BASE_URL + currentId;

                // 1. Ajouter au CSV
                csvContent += `${currentId},${fullUrl}\n`;

                // 2. Cr√©er dans Firebase (vide par d√©faut)
                let promise = db.collection("plaques").doc(currentId).set({
                    url: "", // Pas de lien client pour l'instant
                    scans: 0,
                    createdAt: new Date()
                }, { merge: true }); // merge: true √©vite d'√©craser si existe d√©j√†
                
                batchPromises.push(promise);
            }

            try {
                await Promise.all(batchPromises);
                
                // 3. T√©l√©charger le CSV
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `export_usine_${start}_a_${start+qty-1}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                status.innerHTML = `<span class="text-success">‚úÖ ${qty} plaques g√©n√©r√©es ! CSV t√©l√©charg√©.</span>`;
                loadPlaques(); // Rafra√Æchir le tableau

            } catch (error) {
                console.error(error);
                status.innerHTML = `<span class="text-danger">Erreur : ${error.message}</span>`;
            }
        }

        // --- FONCTION 2 : AFFICHER TABLEAU ---
        function loadPlaques() {
            const tbody = document.getElementById('tableBody');
            
            db.collection("plaques").orderBy("createdAt", "desc").limit(100).get().then((snapshot) => {
                tbody.innerHTML = "";
                
                if (snapshot.empty) {
                    tbody.innerHTML = "<tr><td colspan='5' class='text-center'>Aucune plaque. Utilisez le g√©n√©rateur.</td></tr>";
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const factoryLink = BASE_URL + id;
                    const clientUrl = data.url || "";
                    
                    const row = `
                        <tr>
                            <td class="fw-bold">${id}</td>
                            <td><span class="factory-link">${factoryLink}</span></td>
                            <td>
                                <input type="text" class="form-control form-control-sm" 
                                       placeholder="https://..." 
                                       id="url-${id}" 
                                       value="${clientUrl}">
                            </td>
                            <td class="text-center badge bg-light text-dark border m-2">${data.scans || 0}</td>
                            <td>
                                <button onclick="saveOne('${id}')" class="btn btn-success btn-sm">üíæ</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        // --- FONCTION 3 : SAUVEGARDER UNE LIGNE ---
        function saveOne(id) {
            const newUrl = document.getElementById(`url-${id}`).value;
            db.collection("plaques").doc(id).update({
                url: newUrl
            }).then(() => {
                // Petit effet visuel pour confirmer
                const btn = document.activeElement;
                const originalText = btn.innerText;
                btn.innerText = "‚úÖ";
                setTimeout(() => btn.innerText = "üíæ", 1000);
            });
        }
    </script>
</body>
</html>
