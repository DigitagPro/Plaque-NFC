<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - NFC</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
        .btn-sm { font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-center mb-4">üéõÔ∏è Dashboard Plaques NFC</h1>

        <div class="card p-4">
            <h4>‚ûï Ajouter une nouvelle plaque</h4>
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" id="newId" class="form-control" placeholder="ID (ex: 1002)">
                </div>
                <div class="col-md-7">
                    <input type="url" id="newUrl" class="form-control" placeholder="Lien (ex: instagram.com/...)">
                </div>
                <div class="col-md-2">
                    <button onclick="createPlaque()" class="btn btn-primary w-100">Cr√©er</button>
                </div>
            </div>
            <small id="createStatus" class="mt-2 text-muted"></small>
        </div>

        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>üìã Liste des plaques actives</h4>
                <button onclick="loadPlaques()" class="btn btn-outline-secondary btn-sm">üîÑ Actualiser</button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">ID Plaque</th>
                            <th scope="col">Lien de redirection</th>
                            <th scope="col" class="text-center">Scans</th>
                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plaquesTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBjfZ6GHzg-IkP-i_1RMcWNqvyhSlrUMbk",
            authDomain: "plaques-nfc-c6da0.firebaseapp.com",
            projectId: "plaques-nfc-c6da0",
            storageBucket: "plaques-nfc-c6da0.firebasestorage.app",
            messagingSenderId: "790493007980",
            appId: "1:790493007980:web:de515aa27e78e6a9a58849",
            measurementId: "G-KWT3LZV7S5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Charger les plaques au d√©marrage
        document.addEventListener('DOMContentLoaded', loadPlaques);

        // --- FONCTION : LISTER LES PLAQUES ---
        function loadPlaques() {
            const tbody = document.getElementById('plaquesTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Chargement...</td></tr>';

            db.collection("plaques").orderBy("updatedAt", "desc").get().then((querySnapshot) => {
                tbody.innerHTML = ''; // Vider le tableau
                
                querySnapshot.forEach((doc) => {
                    const plaque = doc.data();
                    const id = doc.id;
                    const url = plaque.url || "";
                    const scans = plaque.scans || 0;

                    // Cr√©er une ligne HTML pour chaque plaque
                    const row = `
                        <tr>
                            <td><strong>${id}</strong></td>
                            <td>
                                <input type="text" class="form-control form-control-sm" value="${url}" id="url-${id}">
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info text-dark">${scans}</span>
                            </td>
                            <td class="text-end">
                                <button onclick="updatePlaque('${id}')" class="btn btn-success btn-sm">üíæ Sauver</button>
                                <button onclick="deletePlaque('${id}')" class="btn btn-danger btn-sm" title="Supprimer">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                if(querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune plaque trouv√©e. Cr√©ez-en une !</td></tr>';
                }
            });
        }

        // --- FONCTION : CR√âER UNE PLAQUE ---
        function createPlaque() {
            const id = document.getElementById('newId').value.trim();
            const url = document.getElementById('newUrl').value.trim();
            const status = document.getElementById('createStatus');

            if(!id || !url) {
                status.innerText = "‚ùå Merci de remplir l'ID et l'URL";
                status.style.color = "red";
                return;
            }

            db.collection("plaques").doc(id).set({
                url: url,
                scans: 0,
                updatedAt: new Date()
            }).then(() => {
                status.innerText = "‚úÖ Plaque cr√©√©e avec succ√®s !";
                status.style.color = "green";
                document.getElementById('newId').value = "";
                document.getElementById('newUrl').value = "";
                loadPlaques(); // Recharger le tableau
            }).catch((error) => {
                console.error(error);
                status.innerText = "Erreur: " + error.message;
            });
        }

        // --- FONCTION : METTRE √Ä JOUR UNE LIGNE ---
        function updatePlaque(id) {
            const newUrl = document.getElementById(`url-${id}`).value;
            
            db.collection("plaques").doc(id).update({
                url: newUrl,
                updatedAt: new Date()
            }).then(() => {
                alert(`Plaque ${id} mise √† jour !`);
            }).catch((error) => {
                alert("Erreur : " + error.message);
            });
        }

        // --- FONCTION : SUPPRIMER UNE PLAQUE ---
        function deletePlaque(id) {
            if(confirm("Es-tu s√ªr de vouloir supprimer la plaque " + id + " ? Cela cassera le lien QR Code.")) {
                db.collection("plaques").doc(id).delete().then(() => {
                    loadPlaques();
                });
            }
        }
    </script>
</body>
</html>
